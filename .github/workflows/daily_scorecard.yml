name: Scan all repos with Scorecard & Aggregate

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 3 * * 4' # Weekly, adjust UTC as needed

jobs:
  scan_all_repos:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update && sudo apt install -y jq curl
          curl -sSL https://github.com/ossf/scorecard/releases/latest/download/scorecard-checks_linux_x86_64.tar.gz | tar -xz
          sudo mv scorecard /usr/local/bin/

      - name: List all repositories
        id: list_repos
        run: |
          echo "REPOS=$(curl -H \"Authorization: token ${{ secrets.ALL_REPOS_TOKEN }}\" \
            https://api.github.com/user/repos?per_page=100 | jq -r '.[].full_name' | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Run Scorecard on all repos
        run: |
          mkdir -p results
          for repo in $REPOS; do
            echo "Scanning $repo..."
            scorecard --repo="https://github.com/$repo" --format=json > "results/${repo//\//_}.json"
          done

      - name: Aggregate Scores
        run: |
          total_score=0
          count=0
          for file in results/*.json; do
            score=$(jq '.Score' "$file")
            total_score=$(echo "$total_score + $score" | bc)
            count=$((count + 1))
          done
          avg=$(echo "scale=2; $total_score / $count" | bc)
          echo "Average Scorecard score across $count repos: $avg"
          echo "{\"average_score\": $avg, \"repo_count\": $count}" > results/aggregate.json

      - name: Upload All Results
        uses: actions/upload-artifact@v3
        with:
          name: all-repos-scorecard
          path: results/
