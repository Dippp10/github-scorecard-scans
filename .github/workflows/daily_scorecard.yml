name: Scan all repos & update README

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 4' # Weekly at 3:00 UTC

jobs:
  scan_and_update_readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Install dependencies
        run: |
          sudo apt update && sudo apt install -y jq curl bc
          curl -sSL https://github.com/ossf/scorecard/releases/latest/download/scorecard-checks_linux_x86_64.tar.gz | tar -xz
          sudo mv scorecard /usr/local/bin/

      - name: List all repositories
        run: |
          echo "REPOS=$(curl -H \"Authorization: token ${{ secrets.ALL_REPOS_TOKEN }}\" \
            https://api.github.com/user/repos?per_page=100 | jq -r '.[].full_name' | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Run Scorecard on all repos
        run: |
          mkdir -p results
          for repo in $REPOS; do
            echo "Scanning $repo..."
            scorecard --repo="https://github.com/$repo" --format=json > "results/${repo//\//_}.json"
          done

      - name: Generate Markdown Table
        id: gen_table
        run: |
          echo "| Repository | Score | Link |" > table.md
          echo "|------------|-------|------|" >> table.md
          total_score=0
          count=0
          for file in results/*.json; do
            repo_name=$(basename "$file" .json | tr '_' '/')
            score=$(jq '.Score' "$file")
            total_score=$(echo "$total_score + $score" | bc)
            count=$((count + 1))
            echo "| $repo_name | $score | [Link](https://github.com/$repo_name) |" >> table.md
          done
          avg=$(echo "scale=2; $total_score / $count" | bc)
          echo "" >> table.md
          echo "**Average Score across $count repositories: $avg**" >> table.md

      - name: Update README
        run: |
          # Remove old Scorecard section
          sed -i '/<!-- SCORECARD_START -->/,/<!-- SCORECARD_END -->/d' README.md
          # Add new table
          echo -e "\n<!-- SCORECARD_START -->\n$(cat table.md)\n<!-- SCORECARD_END -->" >> README.md
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update Scorecard report [skip ci]" || echo "No changes to commit"
          git push
