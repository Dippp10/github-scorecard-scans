name: Daily Scorecard Scan CLI

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # daily at 3 AM UTC

permissions:
  contents: write  # needed to push README badge

jobs:
  scorecard:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - uses: actions/checkout@v3

      # 2️⃣ Install dependencies
      - name: Install jq, curl, wget
        run: sudo apt-get update && sudo apt-get install -y jq curl wget bc

      # 3️⃣ Install Scorecard CLI
      - name: Install Scorecard CLI
        run: |
          wget https://github.com/ossf/scorecard/releases/latest/download/scorecard-linux-amd64 -O scorecard
          chmod +x scorecard
          sudo mv scorecard /usr/local/bin/

      # 4️⃣ Fetch all repositories (handles >100 repos)
      - name: Get all repositories
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          page=1
          > all_repos.txt
          while true; do
            repos=$(curl -s -H "Authorization: token $GH_PAT" \
              "https://api.github.com/users/Dippp10/repos?per_page=100&page=$page" \
              | jq -r '.[].full_name')
            if [ -z "$repos" ]; then break; fi
            echo "$repos" >> all_repos.txt
            ((page++))
          done

      # 5️⃣ Run Scorecard in batches and ignore exit code 8
      - name: Run Scorecard in batches
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          split -l 20 all_repos.txt batch_
          mkdir -p scorecard_results
          > combined_results.json
          echo "[" >> combined_results.json
          first=true
          for file in batch_*; do
            repos=$(paste -sd, $file)
            batch_file=scorecard_results/results_$file.json
            ./scorecard --repos=$repos --format=json -o $batch_file || true
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> combined_results.json
            fi
            cat $batch_file >> combined_results.json
          done
          echo "]" >> combined_results.json

      # 6️⃣ Upload combined results as artifact (v4)
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: scorecard-results
          path: combined_results.json

      # 7️⃣ Update badge in README
      - name: Update Scorecard badge
        run: |
          score=$(jq '[.[].Score]' combined_results.json | add / length | awk '{printf "%.1f", $1}')
          if (( $(echo "$score >= 8" | bc -l) )); then color="brightgreen"
          elif (( $(echo "$score >= 5" | bc -l) )); then color="yellow"
          else color="red"; fi
          badge="https://img.shields.io/badge/Scorecard-${score}-${color}"
          sed -i "s|!\[Scorecard\](.*)|![Scorecard](${badge})|" README.md
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git diff --exit-code || git commit -am "Update Scorecard badge"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
