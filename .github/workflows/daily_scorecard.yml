name: Scan all repos with Scorecard

on:
  workflow_dispatch: # manual trigger
  schedule:
    - cron: '0 3 * * 4' # weekly

jobs:
  scan_all_repos:
    runs-on: ubuntu-latest
    steps:
      - name: Install Scorecard CLI
        run: |
          curl -sSL https://github.com/ossf/scorecard/releases/latest/download/scorecard-checks_linux_x86_64.tar.gz | tar -xz
          sudo mv scorecard /usr/local/bin/

      - name: Checkout (optional)
        uses: actions/checkout@v3

      - name: List all repos
        id: list_repos
        run: |
          echo "REPOS=$(curl -H \"Authorization: token ${{ secrets.ALL_REPOS_TOKEN }}\" https://api.github.com/user/repos?per_page=100 | jq -r '.[].full_name' | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Run Scorecard on all repos
        run: |
          mkdir -p results
          for repo in $REPOS; do
            echo "Scanning $repo..."
            scorecard --repo="https://github.com/$repo" --format=json > "results/${repo//\//_}.json"
          done

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: all-repos-scorecard
          path: results/
